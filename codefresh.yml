version: "1.0"
stages:
  - "checkout"
  - "package"
  - "deploy"
steps:
  main_clone:
    title: "Cloning Main Repository"
    stage: checkout
    type: "git-clone"
    repo: "rkemery/codefresh-demo"
    revision: "${{CF_BRANCH}}"
    git: "github"
  build_demo_app:
    title: "Building Docker Image - Demo Rust App"
    type: build
    stage: package
    image_name: rkemery/codefresh-demo
    no_cache: false
    dockerfile: Dockerfile
    working_directory: '.'
    tag: "${{CF_BRANCH}}"
    registry: dockerhub
  deploy_to_k8s:
    title: "Deploy Demo Rust App to k8s"
    type: deploy
    stage: deploy
    kind: kubernetes  
    ## cluster name as the shown in account's integration page
    cluster:  rkemery-gke-cluster-01@rkemery-k8s
    # desired namespace
    namespace: default
    service: codefresh-demo
    candidate:
      # The image that will replace the original deployment image 
      # The image that been build using Build step
      image: rkemery/codefresh-demo:${{CF_BRANCH}}
      # The registry that the user's Kubernetes cluster can pull the image from
      # Codefresh will generate (if not found) secret and add it to the deployment so the Kubernetes master can pull it
      registry: dockerhub   
    slack_notify:
      image: tutum/curl
      commands:
        - curl -X POST --data-urlencode 'payload={"text":"Test slack integration via yaml"}' ${{SLACK_WEB_URL}}